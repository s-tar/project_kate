// Generated by CoffeeScript 1.9.3
(function() {
  var Popup, Widget, root;

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  root.base_url = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');

  $(document).ready(function() {
    $.get("/config/sn", function(config) {
      FB.init({
        appId: config.fb.app_id,
        status: true,
        cookie: true,
        xfbml: true
      });
      return VK.init({
        apiId: config.vk.app_id,
        onlyWidgets: true
      });
    });
    root.popup = new Popup();
    return root.widget = new Widget();
  });

  $(window).load(function() {
    return $('body').removeClass('transition-fix');
  });

  Popup = (function() {
    var _background, _close, _content, _popup, _title, _wrapper, last_caller, last_caller_center, self;

    function Popup() {}

    self = Popup;

    _wrapper = $('.popup-wrapper');

    _background = _wrapper.find('.background');

    _popup = _wrapper.find('.popup');

    _title = _popup.find('.title .text');

    _close = _popup.find('.title .close');

    _content = _popup.find('.popup-content');

    last_caller = null;

    last_caller_center = function() {
      var left, top;
      top = 0;
      left = 0;
      if (last_caller) {
        left = last_caller.offset().left + last_caller.outerWidth() / 2 - _wrapper.width() / 2;
        top = last_caller.offset().top + last_caller.outerHeight() / 2 - _wrapper.height() / 2;
      }
      return {
        left: left,
        top: top
      };
    };

    Popup.prototype.show = function(arg) {
      var caller, caller_center, close, content, ref, title;
      ref = arg != null ? arg : {}, title = ref.title, content = ref.content, close = ref.close, caller = ref.caller;
      if (close == null) {
        close = true;
      }
      if (title == null) {
        title = '';
      }
      last_caller = caller;
      caller_center = last_caller_center();
      _popup.css({
        'opacity': '0',
        '-webkit-transform': 'translate(' + caller_center.left + 'px,' + caller_center.top + 'px) scale(0)',
        '-moz-transform': 'translate(' + caller_center.left + 'px,' + caller_center.top + 'px) scale(0)',
        '-ms-transform': 'translate(' + caller_center.left + 'px,' + caller_center.top + 'px) scale(0)',
        '-o-transform': 'translate(' + caller_center.left + 'px,' + caller_center.top + 'px) scale(0)',
        'transform': 'translate(' + caller_center.left + 'px,' + caller_center.top + 'px) scale(0)'
      });
      if (close) {
        _close.show();
      } else {
        _close.hide();
      }
      _title.html(title);
      _content.html(content);
      root.apply_plugins(_content);
      _wrapper.show();
      return setTimeout(function() {
        _background.addClass('visible');
        return _popup.css({
          'opacity': '1',
          '-webkit-transform': '',
          '-moz-transform': '',
          '-ms-transform': '',
          '-o-transform': '',
          'transform': ''
        });
      }, 1);
    };

    Popup.prototype.hide = function(direction, scale) {
      var d;
      d = last_caller_center();
      if (!scale) {
        scale = 0;
      }
      switch (direction) {
        case "bottom":
          d = {
            left: 0,
            top: _wrapper.height() / 2
          };
          break;
        case "top":
          d = {
            left: 0,
            top: -_wrapper.height() / 2
          };
          break;
        case "left":
          d = {
            left: -_wrapper.width() / 2,
            top: 0
          };
          break;
        case "right":
          d = {
            left: _wrapper.width() / 2,
            top: 0
          };
      }
      _popup.css({
        'opacity': '0',
        '-webkit-transform': 'translate(' + d.left + 'px,' + d.top + 'px) scale(' + scale + ')',
        '-moz-transform': 'translate(' + d.left + 'px,' + d.top + 'px) scale(' + scale + ')',
        '-ms-transform': 'translate(' + d.left + 'px,' + d.top + 'px) scale(' + scale + ')',
        '-o-transform': 'translate(' + d.left + 'px,' + d.top + 'px) scale(' + scale + ')',
        'transform': 'translate(' + d.left + 'px,' + d.top + 'px) scale(' + scale + ')'
      });
      _background.removeClass('visible');
      return setTimeout(function() {
        return _wrapper.hide();
      }, 400);
    };

    return Popup;

  })();

  $(document).on('click', '.popup-wrapper .title .close', function() {
    return root.popup.hide();
  });

  Widget = (function() {
    function Widget() {}

    Widget.prototype.update = function(name, cb) {
      var attr, widget;
      widget = typeof name === 'string' ? $('div[widget="' + name + '"]') : name;
      attr = {};
      $(widget[0].attributes).each(function() {
        return attr[this.nodeName] = this.value;
      });
      if (widget.length) {
        return $.ajax({
          type: "POST",
          url: root.base_url + "/widget/" + widget.attr('widget'),
          data: attr,
          dataType: 'html',
          success: function(data) {
            widget.html(data);
            if (typeof cb === 'function') {
              return cb();
            }
          }
        });
      }
    };

    Widget.prototype.get = function(name, attr, cb) {
      return $.ajax({
        type: "POST",
        url: base_url + "/widget/" + name,
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({
          "data": attr
        }),
        dataType: 'html',
        success: function(html) {
          if (typeof cb === 'function') {
            return cb(html);
          }
        }
      });
    };

    return Widget;

  })();

  root.apply_plugins = function(content) {
    return content.find('.image-loader').ImageLoader();
  };

}).call(this);
